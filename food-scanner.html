<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Barcode Scanner with Nutrition - Calculated Decisions</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2f4f49;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 20px 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .company-logo { max-width: 198px; height: auto; margin-bottom: 15px; }
        .company-name {
            color: #ffffff;
            text-decoration: none;
            font-size: 24px;
            font-weight: 600;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .company-name:hover { color: #4CAF50; transform: translateY(-2px); }
        h1 { font-size: 22px; font-weight: 600; margin: 20px 0 5px; }
        .subtitle { font-size: 14px; opacity: 0.9; }
        main { flex: 1; padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }
        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #1a1a1a;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        #scanner { width: 100%; height: 100%; }
        #scanner video { width: 100% !important; height: 100% !important; object-fit: cover; }
        #scanner canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 150px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            pointer-events: none;
            animation: pulse 2s infinite;
            z-index: 1;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .primary-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .secondary-btn {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .secondary-btn:hover { background: rgba(0, 0, 0, 0.5); transform: translateY(-2px); }
        .manual-entry, .ocr-section, .produce-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #ccc; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); }
        .barcode-input-group { display: flex; gap: 10px; }
        .barcode-input-group input { flex: 1; }
        .fetch-button {
            padding: 12px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        .fetch-button:hover { background: #1976D2; transform: translateY(-1px); }
        .nutrition-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .serving-size-group { grid-column: 1 / -1; display: flex; gap: 10px; margin-bottom: 10px; }
        .serving-size-group input { flex: 1; }
        .food-list { background: rgba(0, 0, 0, 0.2); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .food-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .food-item:hover { transform: translateX(5px); border-color: #4CAF50; }
        .food-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .food-info { flex: 1; }
        .food-name { font-weight: 600; font-size: 18px; margin-bottom: 3px; }
        .food-details { font-size: 12px; color: #ccc; }
        .serving-info { font-size: 14px; color: #4CAF50; margin-top: 5px; }
        .nutrition-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .nutrition-item { background: rgba(0, 0, 0, 0.4); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); }
        .nutrition-value { font-size: 20px; font-weight: 600; color: #4CAF50; }
        .nutrition-label { font-size: 12px; color: #ccc; margin-top: 2px; }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .edit-btn:hover { background: #1976D2; transform: scale(1.05); }
        .delete-btn { background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .delete-btn:hover { background: #cc0000; transform: scale(1.05); }
        .export-section { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .export-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
            flex: none;
        }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4); }
        .clear-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            flex: none;
        }
        .clear-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); }
        .empty-state { text-align: center; padding: 40px; color: #aaa; }
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .status-message.show { transform: translateX(0); }
        .status-message.success { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .status-message.error { background: linear-gradient(135deg, #ff4444, #cc0000); color: white; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #2f4f49;
            padding: 25px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .ocr-button {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .ocr-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4); }
        #imageInput { display: none; }
        .image-preview { max-width: 100%; max-height: 300px; margin: 15px auto; display: none; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .ocr-status { text-align: center; padding: 15px; margin: 15px 0; border-radius: 8px; background: rgba(0, 0, 0, 0.3); display: none; }
        .ocr-results { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-top: 15px; display: none; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .product-image { width: 150px; height: 150px; object-fit: contain; margin: 0 auto 20px; display: block; border-radius: 8px; background: rgba(0, 0, 0, 0.3); }
        .beta-tag { font-size: 12px; background: #ff9800; color: #000; padding: 2px 8px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        .produce-button {
            background: linear-gradient(135deg, #8BC34A, #689F38);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        .produce-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 195, 74, 0.4); }
        .search-results { margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .search-result-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .search-result-item:hover { background: rgba(0, 0, 0, 0.5); border-color: #4CAF50; }
        .search-result-name { font-weight: 600; margin-bottom: 4px; }
        .search-result-brand { font-size: 12px; color: #ccc; }
    </style>
</head>
<body>
    <header>
        <img src="https://img1.wsimg.com/isteam/ip/17da66aa-05e0-4e17-aec0-570151a3c322/blob-f3b648f.png/:/rs=w:198,h:112,cg:true,m/cr=w:198,h:112/qt=q:95" alt="Calculated Decisions Logo" class="company-logo">
        <br>
        <a href="https://calculated-decisions.com/" class="company-name" target="_blank">Calculated Decisions</a>
        <h1>üçé Food Scanner & Nutrition Tracker</h1>
        <p class="subtitle">Scan barcodes or search foods to track nutrition info</p>
    </header>

    <main>
        <div id="scanner-container">
            <div id="scanner"></div>
            <div class="scanner-overlay"></div>
        </div>

        <div class="controls">
            <button id="startBtn" class="primary-btn">Start Scanner</button>
            <button id="stopBtn" class="secondary-btn" style="display: none;">Stop Scanner</button>
        </div>

        <div class="produce-section">
            <h3 style="margin-bottom: 15px;">ü•¨ Search Produce & Foods</h3>
            <p style="font-size: 13px; color: #ccc; margin-bottom: 15px;">For items without barcodes like fruits, vegetables, or bulk foods</p>
            <div class="barcode-input-group" style="margin-bottom: 15px;">
                <input type="text" id="produceSearch" placeholder="e.g., banana, apple, chicken breast">
                <button type="button" class="produce-button" style="flex: none; width: auto; padding: 12px 20px;" onclick="searchProduce()">Search</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="ocr-section">
            <h3 style="margin-bottom: 15px;">üì∏ Scan Nutrition Label <span class="beta-tag">BETA</span></h3>
            <input type="file" id="imageInput" accept="image/*" capture="environment" onchange="processImage(event)">
            <button class="ocr-button" onclick="document.getElementById('imageInput').click()">
                Take Photo / Upload Nutrition Label
            </button>
            <img id="imagePreview" class="image-preview" alt="Nutrition label preview">
            <div id="ocrStatus" class="ocr-status"></div>
            <div id="ocrResults" class="ocr-results"></div>
        </div>

        <div class="manual-entry">
            <h3 style="margin-bottom: 15px;">‚úèÔ∏è Manual Entry</h3>
            <div class="form-group">
                <label for="foodName">Food Name</label>
                <input type="text" id="foodName" placeholder="e.g., Organic Pasta">
            </div>
            <div class="form-group">
                <label for="barcode">Barcode (optional)</label>
                <div class="barcode-input-group">
                    <input type="text" id="barcode" placeholder="e.g., 123456789">
                    <button type="button" id="fetchBtn" class="fetch-button" onclick="fetchByBarcode()">Fetch Info</button>
                </div>
            </div>
            <div class="form-group">
                <label for="brand">Brand (optional)</label>
                <input type="text" id="brand" placeholder="e.g., Nature's Best">
            </div>
            <div class="form-group">
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label>Nutrition per serving (optional)</label>
                <div class="serving-size-group">
                    <input type="text" id="servingSize" placeholder="Serving size (e.g., 1 cup, 100g)">
                    <input type="number" id="servingsPerContainer" placeholder="Servings per container" step="0.1">
                </div>
                <div class="nutrition-inputs">
                    <input type="number" id="calories" placeholder="Calories" step="0.1">
                    <input type="number" id="protein" placeholder="Protein (g)" step="0.1">
                    <input type="number" id="carbs" placeholder="Carbs (g)" step="0.1">
                    <input type="number" id="fat" placeholder="Fat (g)" step="0.1">
                    <input type="number" id="fiber" placeholder="Fiber (g)" step="0.1">
                    <input type="number" id="sugar" placeholder="Sugar (g)" step="0.1">
                    <input type="number" id="sodium" placeholder="Sodium (mg)" step="0.1">
                    <input type="number" id="saturatedFat" placeholder="Saturated Fat (g)" step="0.1">
                </div>
            </div>
            <button onclick="addManualItem()" class="primary-btn">Add Item</button>
        </div>

        <div class="food-list">
            <h3 style="margin-bottom: 15px;">üì¶ Your Food Inventory</h3>
            <div id="foodItems"></div>
        </div>

        <div class="export-section">
            <button onclick="exportToCSV()" class="export-btn">üì• Export to CSV</button>
            <button onclick="clearAllItems()" class="clear-btn">üóëÔ∏è Clear All</button>
        </div>
    </main>

    <div id="statusMessage" class="status-message"></div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Product Found!</div>
            <img id="productImage" class="product-image" src="" alt="">
            <div id="productInfo"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="confirmProduct()" class="primary-btn">Add to Inventory</button>
                <button onclick="closeModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let foodInventory = [];
        let scanning = false;
        let pendingProduct = null;

        function loadInventory() {
            const saved = localStorage.getItem('foodInventory');
            if (saved) {
                foodInventory = JSON.parse(saved);
                updateDisplay();
            }
        }

        function saveInventory() {
            localStorage.setItem('foodInventory', JSON.stringify(foodInventory));
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            setTimeout(() => { statusEl.classList.remove('show'); }, 3000);
        }

        // DELETE ITEM FUNCTION (was missing!)
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                foodInventory = foodInventory.filter(item => item.id !== id);
                saveInventory();
                updateDisplay();
                showStatus('Item deleted');
            }
        }

        // CLEAR ALL FUNCTION
        function clearAllItems() {
            if (foodInventory.length === 0) {
                showStatus('Inventory is already empty', 'error');
                return;
            }
            if (confirm(`Are you sure you want to clear all ${foodInventory.length} items? This cannot be undone.`)) {
                foodInventory = [];
                saveInventory();
                updateDisplay();
                showStatus('All items cleared');
            }
        }

        // PRODUCE SEARCH FUNCTION
        async function searchProduce() {
            const query = document.getElementById('produceSearch').value.trim();
            if (!query) {
                showStatus('Please enter a food name to search', 'error');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="text-align: center; color: #ccc;">Searching...</p>';

            try {
                const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=10`);
                const data = await response.json();

                if (data.products && data.products.length > 0) {
                    resultsDiv.innerHTML = data.products.map(product => {
                        const name = product.product_name || 'Unknown Product';
                        const brand = product.brands || 'Generic';
                        const calories = product.nutriments?.['energy-kcal_100g'] || 'N/A';
                        return `
                            <div class="search-result-item" onclick='selectSearchResult(${JSON.stringify({
                                name: name,
                                brand: brand,
                                barcode: product.code || '',
                                image: product.image_url || '',
                                servingSize: product.serving_size || '100g',
                                nutrition: {
                                    calories: Math.round(product.nutriments?.['energy-kcal_100g'] || 0),
                                    protein: Math.round((product.nutriments?.proteins_100g || 0) * 10) / 10,
                                    carbs: Math.round((product.nutriments?.carbohydrates_100g || 0) * 10) / 10,
                                    fat: Math.round((product.nutriments?.fat_100g || 0) * 10) / 10,
                                    fiber: Math.round((product.nutriments?.fiber_100g || 0) * 10) / 10,
                                    sugar: Math.round((product.nutriments?.sugars_100g || 0) * 10) / 10,
                                    sodium: Math.round((product.nutriments?.salt_100g || 0) * 393) || 0
                                }
                            }).replace(/'/g, "&apos;")})'>
                                <div class="search-result-name">${name}</div>
                                <div class="search-result-brand">${brand} ‚Ä¢ ${calories} cal/100g</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: #ccc;">No results found. Try a different search term or add manually below.</p>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<p style="text-align: center; color: #ff4444;">Search failed. Please try again.</p>';
            }
        }

        function selectSearchResult(product) {
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('produceSearch').value = '';
            pendingProduct = {
                ...product,
                nutritionPer: 'per 100g'
            };
            showProductModal(pendingProduct);
        }

        // Allow Enter key to search produce
        document.getElementById('produceSearch')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchProduce();
        });

        async function fetchProductInfo(barcode, useServingSize = true) {
            try {
                showStatus('Fetching product information...', 'success');
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const product = data.product;
                    const nutrition = product.nutriments || {};
                    
                    let nutritionData = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0, sugar: 0, sodium: 0 };
                    let servingSize = product.serving_size || '';
                    let nutritionPer = 'per serving';
                    
                    if (useServingSize && nutrition['energy-kcal_serving']) {
                        nutritionData = {
                            calories: Math.round(nutrition['energy-kcal_serving'] || 0),
                            protein: Math.round((nutrition.proteins_serving || 0) * 10) / 10,
                            carbs: Math.round((nutrition.carbohydrates_serving || 0) * 10) / 10,
                            fat: Math.round((nutrition.fat_serving || 0) * 10) / 10,
                            fiber: Math.round((nutrition.fiber_serving || 0) * 10) / 10,
                            sugar: Math.round((nutrition.sugars_serving || 0) * 10) / 10,
                            sodium: Math.round((nutrition.salt_serving || 0) * 393) || 0
                        };
                    } else if (nutrition['energy-kcal_100g']) {
                        nutritionData = {
                            calories: Math.round(nutrition['energy-kcal_100g'] || 0),
                            protein: Math.round((nutrition.proteins_100g || 0) * 10) / 10,
                            carbs: Math.round((nutrition.carbohydrates_100g || 0) * 10) / 10,
                            fat: Math.round((nutrition.fat_100g || 0) * 10) / 10,
                            fiber: Math.round((nutrition.fiber_100g || 0) * 10) / 10,
                            sugar: Math.round((nutrition.sugars_100g || 0) * 10) / 10,
                            sodium: Math.round((nutrition.salt_100g || 0) * 393) || 0
                        };
                        nutritionPer = 'per 100g';
                        if (!servingSize) servingSize = '100g';
                    }
                    
                    return {
                        name: product.product_name || `Product ${barcode}`,
                        brand: product.brands || 'Unknown Brand',
                        barcode: barcode,
                        image: product.image_url || '',
                        nutrition: nutritionData,
                        servingSize: servingSize,
                        nutritionPer: nutritionPer,
                        servingsPerContainer: product.servings_per_container || ''
                    };
                } else {
                    return { name: `Product ${barcode}`, brand: 'Unknown', barcode: barcode, nutrition: null };
                }
            } catch (error) {
                console.error('Error fetching product:', error);
                showStatus('Could not fetch product info', 'error');
                return { name: `Product ${barcode}`, brand: 'Unknown', barcode: barcode, nutrition: null };
            }
        }

        async function fetchByBarcode() {
            const barcode = document.getElementById('barcode').value.trim();
            if (!barcode) { showStatus('Please enter a barcode', 'error'); return; }
            
            const productInfo = await fetchProductInfo(barcode);
            
            if (productInfo.name !== `Product ${barcode}`) {
                document.getElementById('foodName').value = productInfo.name;
                document.getElementById('brand').value = productInfo.brand;
                
                if (productInfo.nutrition) {
                    document.getElementById('servingSize').value = productInfo.servingSize || '';
                    document.getElementById('servingsPerContainer').value = productInfo.servingsPerContainer || '';
                    document.getElementById('calories').value = productInfo.nutrition.calories || '';
                    document.getElementById('protein').value = productInfo.nutrition.protein || '';
                    document.getElementById('carbs').value = productInfo.nutrition.carbs || '';
                    document.getElementById('fat').value = productInfo.nutrition.fat || '';
                    document.getElementById('fiber').value = productInfo.nutrition.fiber || '';
                    document.getElementById('sugar').value = productInfo.nutrition.sugar || '';
                    document.getElementById('sodium').value = productInfo.nutrition.sodium || '';
                }
                showStatus(`Product found: ${productInfo.name}`, 'success');
            } else {
                showStatus('Product not found in database', 'error');
            }
        }

        function showProductModal(product) {
            pendingProduct = product;
            const modal = document.getElementById('productModal');
            const image = document.getElementById('productImage');
            const info = document.getElementById('productInfo');
            
            if (product.image) { image.src = product.image; image.style.display = 'block'; }
            else { image.style.display = 'none'; }
            
            let nutritionHtml = '';
            if (product.nutrition && product.nutrition.calories !== undefined) {
                nutritionHtml = `
                    <p style="text-align: center; color: #4CAF50; margin-bottom: 10px;">
                        ${product.nutritionPer || 'per serving'} ${product.servingSize ? `(${product.servingSize})` : ''}
                    </p>
                    <div class="nutrition-grid">
                        <div class="nutrition-item"><div class="nutrition-value">${product.nutrition.calories}</div><div class="nutrition-label">Calories</div></div>
                        <div class="nutrition-item"><div class="nutrition-value">${product.nutrition.protein}g</div><div class="nutrition-label">Protein</div></div>
                        <div class="nutrition-item"><div class="nutrition-value">${product.nutrition.carbs}g</div><div class="nutrition-label">Carbs</div></div>
                        <div class="nutrition-item"><div class="nutrition-value">${product.nutrition.fat}g</div><div class="nutrition-label">Fat</div></div>
                        ${product.nutrition.sodium ? `<div class="nutrition-item"><div class="nutrition-value">${product.nutrition.sodium}</div><div class="nutrition-label">Sodium (mg)</div></div>` : ''}
                    </div>`;
            } else {
                nutritionHtml = '<p style="color: #ccc; text-align: center; margin-top: 10px;">No nutrition information available</p>';
            }
            
            info.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 5px;">${product.name}</h3>
                <p style="text-align: center; color: #ccc; margin-bottom: 15px;">${product.brand}</p>
                ${nutritionHtml}
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="color: #aaa; font-size: 14px; margin-bottom: 10px;">Review and edit before adding:</p>
                    <button onclick="editBeforeAdd()" class="edit-btn" style="width: 100%; margin-bottom: 10px;">Edit Nutrition Info</button>
                </div>`;
            
            modal.style.display = 'flex';
        }

        function closeModal() { document.getElementById('productModal').style.display = 'none'; pendingProduct = null; }

        function confirmProduct() {
            if (pendingProduct) {
                const foodItem = { id: Date.now(), ...pendingProduct, quantity: 1, dateAdded: new Date().toISOString() };
                foodInventory.push(foodItem);
                saveInventory();
                updateDisplay();
                showStatus(`Added: ${pendingProduct.name}`);
                closeModal();
            }
        }

        function initializeScanner() {
            if (scanning) return;
            
            scanning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            const config = {
                inputStream: {
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: { width: { min: 640, ideal: 1280 }, height: { min: 480, ideal: 720 }, facingMode: isMobile ? "environment" : "user" }
                },
                locator: { patchSize: "large", halfSample: false },
                numOfWorkers: 4,
                frequency: 5,
                decoder: { readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader", "code_128_reader"] },
                locate: true
            };
            
            Quagga.init(config, function(err) {
                if (err) {
                    console.error('Quagga init error:', err);
                    showStatus('Camera access denied or not available', 'error');
                    scanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    return;
                }
                Quagga.start();
                showStatus('Scanner ready - hold barcode steady', 'success');
            });

            let detectionBuffer = [];
            
            Quagga.onDetected(async function(result) {
                const code = result.codeResult.code;
                detectionBuffer.push(code);
                if (detectionBuffer.length > 5) detectionBuffer.shift();
                
                const counts = {};
                detectionBuffer.forEach(c => { counts[c] = (counts[c] || 0) + 1; });
                
                let mostCommon = null, maxCount = 0;
                for (const [barcode, count] of Object.entries(counts)) {
                    if (count > maxCount) { maxCount = count; mostCommon = barcode; }
                }
                
                if (maxCount >= 3) {
                    Quagga.stop();
                    scanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    detectionBuffer = [];
                    const productInfo = await fetchProductInfo(mostCommon);
                    showProductModal(productInfo);
                }
            });
        }

        document.getElementById('startBtn').addEventListener('click', initializeScanner);
        document.getElementById('stopBtn').addEventListener('click', function() {
            if (scanning) {
                Quagga.stop();
                scanning = false;
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
            }
        });

        function addManualItem() {
            const name = document.getElementById('foodName').value.trim();
            if (!name) { showStatus('Please enter a food name', 'error'); return; }

            const foodItem = {
                id: Date.now(),
                barcode: document.getElementById('barcode').value.trim() || 'N/A',
                name: name,
                brand: document.getElementById('brand').value.trim() || 'Generic',
                quantity: parseInt(document.getElementById('quantity').value),
                servingSize: document.getElementById('servingSize').value.trim() || '1 serving',
                servingsPerContainer: document.getElementById('servingsPerContainer').value.trim() || '',
                nutrition: {
                    calories: parseFloat(document.getElementById('calories').value) || 0,
                    protein: parseFloat(document.getElementById('protein').value) || 0,
                    carbs: parseFloat(document.getElementById('carbs').value) || 0,
                    fat: parseFloat(document.getElementById('fat').value) || 0,
                    fiber: parseFloat(document.getElementById('fiber').value) || 0,
                    sugar: parseFloat(document.getElementById('sugar').value) || 0,
                    sodium: parseFloat(document.getElementById('sodium').value) || 0,
                    saturatedFat: parseFloat(document.getElementById('saturatedFat').value) || 0
                },
                dateAdded: new Date().toISOString()
            };

            foodInventory.push(foodItem);
            saveInventory();
            updateDisplay();
            clearForm();
            showStatus('Item added successfully');
        }

        function editItem(id) {
            const item = foodInventory.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('foodName').value = item.name;
            document.getElementById('barcode').value = item.barcode !== 'N/A' ? item.barcode : '';
            document.getElementById('brand').value = item.brand;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('servingSize').value = item.servingSize || '';
            document.getElementById('servingsPerContainer').value = item.servingsPerContainer || '';
            
            if (item.nutrition) {
                document.getElementById('calories').value = item.nutrition.calories || '';
                document.getElementById('protein').value = item.nutrition.protein || '';
                document.getElementById('carbs').value = item.nutrition.carbs || '';
                document.getElementById('fat').value = item.nutrition.fat || '';
                document.getElementById('fiber').value = item.nutrition.fiber || '';
                document.getElementById('sugar').value = item.nutrition.sugar || '';
                document.getElementById('sodium').value = item.nutrition.sodium || '';
                document.getElementById('saturatedFat').value = item.nutrition.saturatedFat || '';
            }
            
            const addButton = document.querySelector('.manual-entry button[onclick="addManualItem()"]');
            addButton.textContent = 'Update Item';
            addButton.setAttribute('onclick', `updateItem(${id})`);
            document.querySelector('.manual-entry').scrollIntoView({ behavior: 'smooth' });
            showStatus('Editing item - make changes and click Update', 'success');
        }

        function updateItem(id) {
            const name = document.getElementById('foodName').value.trim();
            if (!name) { showStatus('Please enter a food name', 'error'); return; }
            
            const itemIndex = foodInventory.findIndex(i => i.id === id);
            if (itemIndex === -1) return;
            
            foodInventory[itemIndex] = {
                ...foodInventory[itemIndex],
                name: name,
                barcode: document.getElementById('barcode').value.trim() || 'N/A',
                brand: document.getElementById('brand').value.trim() || 'Generic',
                quantity: parseInt(document.getElementById('quantity').value),
                servingSize: document.getElementById('servingSize').value.trim() || '1 serving',
                servingsPerContainer: document.getElementById('servingsPerContainer').value.trim() || '',
                nutrition: {
                    calories: parseFloat(document.getElementById('calories').value) || 0,
                    protein: parseFloat(document.getElementById('protein').value) || 0,
                    carbs: parseFloat(document.getElementById('carbs').value) || 0,
                    fat: parseFloat(document.getElementById('fat').value) || 0,
                    fiber: parseFloat(document.getElementById('fiber').value) || 0,
                    sugar: parseFloat(document.getElementById('sugar').value) || 0,
                    sodium: parseFloat(document.getElementById('sodium').value) || 0,
                    saturatedFat: parseFloat(document.getElementById('saturatedFat').value) || 0
                }
            };
            
            saveInventory();
            updateDisplay();
            clearForm();
            const addButton = document.querySelector('.manual-entry button[onclick^="updateItem"]');
            addButton.textContent = 'Add Item';
            addButton.setAttribute('onclick', 'addManualItem()');
            showStatus('Item updated successfully');
        }

        function editBeforeAdd() {
            if (!pendingProduct) return;
            closeModal();
            
            document.getElementById('foodName').value = pendingProduct.name;
            document.getElementById('barcode').value = pendingProduct.barcode;
            document.getElementById('brand').value = pendingProduct.brand;
            document.getElementById('servingSize').value = pendingProduct.servingSize || '';
            document.getElementById('servingsPerContainer').value = pendingProduct.servingsPerContainer || '';
            
            if (pendingProduct.nutrition) {
                document.getElementById('calories').value = pendingProduct.nutrition.calories || '';
                document.getElementById('protein').value = pendingProduct.nutrition.protein || '';
                document.getElementById('carbs').value = pendingProduct.nutrition.carbs || '';
                document.getElementById('fat').value = pendingProduct.nutrition.fat || '';
                document.getElementById('fiber').value = pendingProduct.nutrition.fiber || '';
                document.getElementById('sugar').value = pendingProduct.nutrition.sugar || '';
                document.getElementById('sodium').value = pendingProduct.nutrition.sodium || '';
            }
            
            document.querySelector('.manual-entry').scrollIntoView({ behavior: 'smooth' });
            showStatus('Review and edit the information before adding', 'success');
            pendingProduct = null;
        }

        function clearForm() {
            ['foodName', 'barcode', 'brand', 'servingSize', 'servingsPerContainer', 'calories', 'protein', 'carbs', 'fat', 'fiber', 'sugar', 'sodium', 'saturatedFat'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('quantity').value = '1';
        }

        function updateDisplay() {
            const container = document.getElementById('foodItems');
            
            if (foodInventory.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in inventory. Start scanning or add items manually!</div>';
                return;
            }

            container.innerHTML = foodInventory.map(item => {
                let nutritionHtml = '';
                if (item.nutrition && item.nutrition.calories !== undefined) {
                    nutritionHtml = `
                        <div class="nutrition-grid">
                            <div class="nutrition-item"><div class="nutrition-value">${item.nutrition.calories}</div><div class="nutrition-label">Calories</div></div>
                            <div class="nutrition-item"><div class="nutrition-value">${item.nutrition.protein}g</div><div class="nutrition-label">Protein</div></div>
                            <div class="nutrition-item"><div class="nutrition-value">${item.nutrition.carbs}g</div><div class="nutrition-label">Carbs</div></div>
                            <div class="nutrition-item"><div class="nutrition-value">${item.nutrition.fat}g</div><div class="nutrition-label">Fat</div></div>
                            ${item.nutrition.sodium ? `<div class="nutrition-item"><div class="nutrition-value">${item.nutrition.sodium}</div><div class="nutrition-label">Sodium (mg)</div></div>` : ''}
                        </div>`;
                }
                
                return `
                    <div class="food-item">
                        <div class="food-header">
                            <div class="food-info">
                                <div class="food-name">${item.name}</div>
                                <div class="food-details">${item.brand} ‚Ä¢ Qty: ${item.quantity} ‚Ä¢ Barcode: ${item.barcode}</div>
                                ${item.servingSize ? `<div class="serving-info">Serving: ${item.servingSize}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="edit-btn" onclick="editItem(${item.id})">Edit</button>
                                <button class="delete-btn" onclick="deleteItem(${item.id})">Delete</button>
                            </div>
                        </div>
                        ${nutritionHtml}
                    </div>`;
            }).join('');
        }

        function exportToCSV() {
            if (foodInventory.length === 0) { showStatus('No items to export', 'error'); return; }

            const headers = ['Name', 'Brand', 'Barcode', 'Quantity', 'Serving Size', 'Servings Per Container', 'Calories', 'Protein (g)', 'Carbs (g)', 'Fat (g)', 'Fiber (g)', 'Sugar (g)', 'Sodium (mg)', 'Date Added'];
            const rows = foodInventory.map(item => [
                item.name, item.brand || '', item.barcode, item.quantity, item.servingSize || '', item.servingsPerContainer || '',
                item.nutrition?.calories || '', item.nutrition?.protein || '', item.nutrition?.carbs || '', item.nutrition?.fat || '',
                item.nutrition?.fiber || '', item.nutrition?.sugar || '', item.nutrition?.sodium || '', new Date(item.dateAdded).toLocaleDateString()
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => { csvContent += row.map(cell => `"${cell}"`).join(',') + '\n'; });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food_inventory_nutrition_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showStatus('Inventory exported successfully');
        }

        document.addEventListener('DOMContentLoaded', loadInventory);

        // OCR functionality
        let worker = null;
        
        async function initializeOCR() {
            if (!worker) {
                worker = await Tesseract.createWorker({ logger: m => { if (m.status === 'recognizing text') updateOCRStatus(`Processing... ${Math.round(m.progress * 100)}%`); } });
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
            }
        }

        function updateOCRStatus(message) {
            const status = document.getElementById('ocrStatus');
            status.style.display = 'block';
            status.textContent = message;
        }

        async function processImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('imagePreview');
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(file);

            updateOCRStatus('Initializing OCR...');
            
            try {
                await initializeOCR();
                updateOCRStatus('Scanning nutrition label...');
                const { data: { text } } = await worker.recognize(file);
                
                document.getElementById('ocrResults').textContent = text;
                document.getElementById('ocrResults').style.display = 'block';
                parseNutritionLabel(text);
                updateOCRStatus('‚úì Nutrition information extracted!');
            } catch (error) {
                console.error('OCR Error:', error);
                updateOCRStatus('Error processing image. Please try again.');
            }
        }

        function parseNutritionLabel(text) {
            const normalizedText = text.replace(/\s+/g, ' ').toLowerCase();
            
            function extractValue(patterns, text) {
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const value = match[1] || match[2] || match[0];
                        const numeric = parseFloat(value.replace(/[^\d.]/g, ''));
                        if (!isNaN(numeric)) return numeric;
                    }
                }
                return null;
            }

            const patterns = {
                calories: [/calories[\s:]+(\d+)/i, /(\d+)[\s]*calories/i, /energy[\s:]+(\d+)[\s]*kcal/i],
                protein: [/protein[\s:]+(\d+\.?\d*)[\s]*g/i, /protein[\s:]+(\d+\.?\d*)/i],
                carbs: [/total[\s]*carbohydrate[\s:]+(\d+\.?\d*)[\s]*g/i, /carbohydrate[\s:]+(\d+\.?\d*)[\s]*g/i, /carbs?[\s:]+(\d+\.?\d*)[\s]*g/i],
                fat: [/total[\s]*fat[\s:]+(\d+\.?\d*)[\s]*g/i, /fat[\s:]+(\d+\.?\d*)[\s]*g/i],
                fiber: [/dietary[\s]*fiber[\s:]+(\d+\.?\d*)[\s]*g/i, /fiber[\s:]+(\d+\.?\d*)[\s]*g/i],
                sugar: [/sugars?[\s:]+(\d+\.?\d*)[\s]*g/i, /total[\s]*sugars?[\s:]+(\d+\.?\d*)[\s]*g/i],
                sodium: [/sodium[\s:]+(\d+\.?\d*)[\s]*mg/i, /sodium[\s:]+(\d+\.?\d*)/i]
            };

            const servingSizeMatch = normalizedText.match(/serving size[:\s]+([^\n]+)/i);
            if (servingSizeMatch) {
                const cleaned = servingSizeMatch[1].trim().replace(/\([^)]*\)/g, '').replace(/[^\w\s.\/]/g, '').trim();
                if (cleaned) document.getElementById('servingSize').value = cleaned;
            }

            const fields = { calories: 'calories', protein: 'protein', carbs: 'carbs', fat: 'fat', fiber: 'fiber', sugar: 'sugar', sodium: 'sodium' };
            let extractedCount = 0;
            
            for (const [key, fieldId] of Object.entries(fields)) {
                const value = extractValue(patterns[key], normalizedText);
                if (value !== null) { document.getElementById(fieldId).value = value; extractedCount++; }
            }

            if (extractedCount > 0) {
                showStatus(`Extracted ${extractedCount} nutrition values! Review and adjust as needed.`, 'success');
                document.querySelector('.manual-entry').scrollIntoView({ behavior: 'smooth' });
            } else {
                showStatus('Could not extract nutrition values. Please enter manually.', 'error');
            }
        }

        window.addEventListener('beforeunload', async () => { if (worker) await worker.terminate(); });
    </script>
</body>
</html>
