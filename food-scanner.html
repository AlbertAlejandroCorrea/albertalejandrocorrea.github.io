<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Barcode Scanner with Nutrition - Calculated Decisions</title>
    <script src="https://cdn.jsdelivr.net/npm/@pixelverse/strichjs/dist/strich.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2f4f49;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 20px 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .company-logo {
            max-width: 198px;
            height: auto;
            margin-bottom: 15px;
        }

        .company-name {
            color: #ffffff;
            text-decoration: none;
            font-size: 24px;
            font-weight: 600;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .company-name:hover {
            color: #4CAF50;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 20px 0 5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        main {
            flex: 1;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #1a1a1a;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        #scanner {
            width: 100%;
            height: 100%;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 150px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            pointer-events: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .primary-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .secondary-btn {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .secondary-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateY(-2px);
        }

        .manual-entry {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        .nutrition-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .food-list {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .food-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .food-item:hover {
            transform: translateX(5px);
            border-color: #4CAF50;
        }

        .food-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .food-info {
            flex: 1;
        }

        .food-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 3px;
        }

        .food-details {
            font-size: 12px;
            color: #ccc;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .nutrition-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nutrition-value {
            font-size: 20px;
            font-weight: 600;
            color: #4CAF50;
        }

        .nutrition-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 2px;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .export-section {
            margin-top: 20px;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status-message.error {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2f4f49;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .product-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 0 auto 20px;
            display: block;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .strich-scanner-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://img1.wsimg.com/isteam/ip/17da66aa-05e0-4e17-aec0-570151a3c322/blob-f3b648f.png/:/rs=w:198,h:112,cg:true,m/cr=w:198,h:112/qt=q:95" alt="Calculated Decisions Logo" class="company-logo">
        <br>
        <a href="https://calculated-decisions.com/" class="company-name" target="_blank">Calculated Decisions</a>
        <h1>🍎 Food Scanner & Nutrition Tracker</h1>
        <p class="subtitle">Scan barcodes to track nutrition info</p>
    </header>

    <main>
        <div id="scanner-container">
            <div id="scanner" class="strich-scanner-container"></div>
            <div class="scanner-overlay"></div>
        </div>

        <div class="controls">
            <button id="startBtn" class="primary-btn">Start Scanner</button>
            <button id="stopBtn" class="secondary-btn" style="display: none;">Stop Scanner</button>
        </div>

        <div class="manual-entry">
            <h3 style="margin-bottom: 15px;">Manual Entry</h3>
            <div class="form-group">
                <label for="foodName">Food Name</label>
                <input type="text" id="foodName" placeholder="e.g., Organic Pasta">
            </div>
            <div class="form-group">
                <label for="barcode">Barcode (optional)</label>
                <input type="text" id="barcode" placeholder="e.g., 123456789">
            </div>
            <div class="form-group">
                <label for="brand">Brand (optional)</label>
                <input type="text" id="brand" placeholder="e.g., Nature's Best">
            </div>
            <div class="form-group">
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label>Nutrition per 100g (optional)</label>
                <div class="nutrition-inputs">
                    <input type="number" id="calories" placeholder="Calories" step="0.1">
                    <input type="number" id="protein" placeholder="Protein (g)" step="0.1">
                    <input type="number" id="carbs" placeholder="Carbs (g)" step="0.1">
                    <input type="number" id="fat" placeholder="Fat (g)" step="0.1">
                    <input type="number" id="fiber" placeholder="Fiber (g)" step="0.1">
                    <input type="number" id="sugar" placeholder="Sugar (g)" step="0.1">
                </div>
            </div>
            <button onclick="addManualItem()" class="primary-btn">Add Item</button>
        </div>

        <div class="food-list">
            <h3 style="margin-bottom: 15px;">Your Food Inventory</h3>
            <div id="foodItems"></div>
        </div>

        <div class="export-section">
            <button onclick="exportToCSV()" class="export-btn">📥 Export to CSV</button>
        </div>
    </main>

    <div id="statusMessage" class="status-message"></div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Product Found!</div>
            <img id="productImage" class="product-image" src="" alt="">
            <div id="productInfo"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="confirmProduct()" class="primary-btn">Add to Inventory</button>
                <button onclick="closeModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let foodInventory = [];
        let barcodeScanner = null;
        let pendingProduct = null;

        // Initialize Strich
        StrichSDK.initialize(
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkZW1vLXVzZXIiLCJleHAiOjQ4MzczNTA4OTd9.U7d9-YmSBrUCEB5zOcB54SrI-CuNKKQPF-UhovpUVmM'
        );

        // Load saved inventory
        function loadInventory() {
            const saved = localStorage.getItem('foodInventory');
            if (saved) {
                foodInventory = JSON.parse(saved);
                updateDisplay();
            }
        }

        // Save inventory
        function saveInventory() {
            localStorage.setItem('foodInventory', JSON.stringify(foodInventory));
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Fetch product info from Open Food Facts API
        async function fetchProductInfo(barcode) {
            try {
                showStatus('Fetching product information...', 'success');
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const product = data.product;
                    const nutrition = product.nutriments || {};
                    
                    return {
                        name: product.product_name || `Product ${barcode}`,
                        brand: product.brands || 'Unknown Brand',
                        barcode: barcode,
                        image: product.image_url || '',
                        nutrition: {
                            calories: Math.round(nutrition['energy-kcal_100g'] || 0),
                            protein: Math.round((nutrition.proteins_100g || 0) * 10) / 10,
                            carbs: Math.round((nutrition.carbohydrates_100g || 0) * 10) / 10,
                            fat: Math.round((nutrition.fat_100g || 0) * 10) / 10,
                            fiber: Math.round((nutrition.fiber_100g || 0) * 10) / 10,
                            sugar: Math.round((nutrition.sugars_100g || 0) * 10) / 10,
                            sodium: Math.round((nutrition.sodium_100g || 0) * 1000) / 10 // Convert to mg
                        },
                        servingSize: product.serving_size || '100g'
                    };
                } else {
                    // Product not found in database
                    return {
                        name: `Product ${barcode}`,
                        brand: 'Unknown',
                        barcode: barcode,
                        nutrition: null
                    };
                }
            } catch (error) {
                console.error('Error fetching product:', error);
                showStatus('Could not fetch product info', 'error');
                return {
                    name: `Product ${barcode}`,
                    brand: 'Unknown',
                    barcode: barcode,
                    nutrition: null
                };
            }
        }

        // Show product modal
        function showProductModal(product) {
            pendingProduct = product;
            const modal = document.getElementById('productModal');
            const image = document.getElementById('productImage');
            const info = document.getElementById('productInfo');
            
            if (product.image) {
                image.src = product.image;
                image.style.display = 'block';
            } else {
                image.style.display = 'none';
            }
            
            let nutritionHtml = '';
            if (product.nutrition && product.nutrition.calories) {
                nutritionHtml = `
                    <div class="nutrition-grid" style="margin-top: 15px;">
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.calories}</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.protein}g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.carbs}g</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.fat}g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                    </div>
                `;
            } else {
                nutritionHtml = '<p style="color: #ccc; text-align: center; margin-top: 10px;">No nutrition information available</p>';
            }
            
            info.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 5px;">${product.name}</h3>
                <p style="text-align: center; color: #ccc; margin-bottom: 15px;">${product.brand}</p>
                ${nutritionHtml}
            `;
            
            modal.style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            pendingProduct = null;
        }

        // Confirm product
        function confirmProduct() {
            if (pendingProduct) {
                const foodItem = {
                    id: Date.now(),
                    ...pendingProduct,
                    quantity: 1,
                    dateAdded: new Date().toISOString()
                };
                
                foodInventory.push(foodItem);
                saveInventory();
                updateDisplay();
                showStatus(`Added: ${pendingProduct.name}`);
                closeModal();
            }
        }

        // Start scanner
        document.getElementById('startBtn').addEventListener('click', async function() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            
            try {
                const configuration = {
                    selector: '#scanner',
                    engine: {
                        symbologies: ['Code128', 'EAN13', 'EAN8', 'UPCA', 'UPCE', 'Code39', 'DataMatrix', 'QRCode']
                    },
                    locator: {
                        minLength: 20
                    },
                    overlay: {
                        showCameraSelector: true,
                        showFlashlight: true,
                        showTextHints: true
                    }
                };
                
                barcodeScanner = new StrichSDK.BarcodeReader(configuration);
                
                await barcodeScanner.initialize();
                await barcodeScanner.start();
                
                barcodeScanner.detected = async (detections) => {
                    if (detections.length > 0) {
                        const code = detections[0].data;
                        await barcodeScanner.stop();
                        document.getElementById('startBtn').style.display = 'block';
                        document.getElementById('stopBtn').style.display = 'none';
                        
                        // Fetch product info
                        const productInfo = await fetchProductInfo(code);
                        showProductModal(productInfo);
                    }
                };
                
            } catch (error) {
                console.error('Error starting scanner:', error);
                showStatus('Camera access denied or error occurred', 'error');
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
            }
        });

        // Stop scanner
        document.getElementById('stopBtn').addEventListener('click', async function() {
            if (barcodeScanner) {
                await barcodeScanner.stop();
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
            }
        });

        // Add manual item
        function addManualItem() {
            const name = document.getElementById('foodName').value.trim();
            const barcode = document.getElementById('barcode').value.trim();
            const brand = document.getElementById('brand').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);

            if (!name) {
                showStatus('Please enter a food name', 'error');
                return;
            }

            const foodItem = {
                id: Date.now(),
                barcode: barcode || 'N/A',
                name: name,
                brand: brand || 'Generic',
                quantity: quantity,
                nutrition: {
                    calories: parseFloat(document.getElementById('calories').value) || 0,
                    protein: parseFloat(document.getElementById('protein').value) || 0,
                    carbs: parseFloat(document.getElementById('carbs').value) || 0,
                    fat: parseFloat(document.getElementById('fat').value) || 0,
                    fiber: parseFloat(document.getElementById('fiber').value) || 0,
                    sugar: parseFloat(document.getElementById('sugar').value) || 0,
                    sodium: 0
                },
                dateAdded: new Date().toISOString()
            };

            foodInventory.push(foodItem);
            saveInventory();
            updateDisplay();
            
            // Clear form
            document.getElementById('foodName').value = '';
            document.getElementById('barcode').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('calories').value = '';
            document.getElementById('protein').value = '';
            document.getElementById('carbs').value = '';
            document.getElementById('fat').value = '';
            document.getElementById('fiber').value = '';
            document.getElementById('sugar').value = '';
            
            showStatus('Item added successfully');
        }

        // Delete item
        function deleteItem(id) {
            foodInventory = foodInventory.filter(item => item.id !== id);
            saveInventory();
            updateDisplay();
            showStatus('Item removed');
        }

        // Update display
        function updateDisplay() {
            const container = document.getElementById('foodItems');
            
            if (foodInventory.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in inventory. Start scanning or add items manually!</div>';
                return;
            }

            container.innerHTML = foodInventory.map(item => {
                let nutritionHtml = '';
                if (item.nutrition && item.nutrition.calories !== undefined) {
                    nutritionHtml = `
                        <div class="nutrition-grid">
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.calories}</div>
                                <div class="nutrition-label">Calories</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.protein}g</div>
                                <div class="nutrition-label">Protein</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.carbs}g</div>
                                <div class="nutrition-label">Carbs</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.fat}g</div>
                                <div class="nutrition-label">Fat</div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="food-item">
                        <div class="food-header">
                            <div class="food-info">
                                <div class="food-name">${item.name}</div>
                                <div class="food-details">
                                    ${item.brand} • Qty: ${item.quantity} • Barcode: ${item.barcode}
                                </div>
                            </div>
                            <button class="delete-btn" onclick="deleteItem(${item.id})">Delete</button>
                        </div>
                        ${nutritionHtml}
                    </div>
                `;
            }).join('');
        }

        // Export to CSV
        function exportToCSV() {
            if (foodInventory.length === 0) {
                showStatus('No items to export', 'error');
                return;
            }

            const headers = ['Name', 'Brand', 'Barcode', 'Quantity', 'Calories', 'Protein (g)', 'Carbs (g)', 'Fat (g)', 'Fiber (g)', 'Sugar (g)', 'Sodium (mg)', 'Date Added'];
            const rows = foodInventory.map(item => [
                item.name,
                item.brand || '',
                item.barcode,
                item.quantity,
                item.nutrition?.calories || '',
                item.nutrition?.protein || '',
                item.nutrition?.carbs || '',
                item.nutrition?.fat || '',
                item.nutrition?.fiber || '',
                item.nutrition?.sugar || '',
                item.nutrition?.sodium || '',
                new Date(item.dateAdded).toLocaleDateString()
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food_inventory_nutrition_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showStatus('Inventory exported successfully');
        }

        // Initialize
        loadInventory();

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
