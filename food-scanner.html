<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Barcode Scanner with Nutrition - Calculated Decisions</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2f4f49;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 20px 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .company-logo {
            max-width: 198px;
            height: auto;
            margin-bottom: 15px;
        }

        .company-name {
            color: #ffffff;
            text-decoration: none;
            font-size: 24px;
            font-weight: 600;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .company-name:hover {
            color: #4CAF50;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 20px 0 5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        main {
            flex: 1;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #1a1a1a;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        #scanner {
            width: 100%;
            height: 100%;
        }

        #scanner video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        #scanner canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 150px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            pointer-events: none;
            animation: pulse 2s infinite;
            z-index: 1;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .primary-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .secondary-btn {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .secondary-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateY(-2px);
        }

        .manual-entry {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        .barcode-input-group {
            display: flex;
            gap: 10px;
        }

        .barcode-input-group input {
            flex: 1;
        }

        .fetch-button {
            padding: 12px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .fetch-button:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .nutrition-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .serving-size-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .serving-size-group input {
            flex: 1;
        }

        .food-list {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .food-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .food-item:hover {
            transform: translateX(5px);
            border-color: #4CAF50;
        }

        .food-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .food-info {
            flex: 1;
        }

        .food-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 3px;
        }

        .food-details {
            font-size: 12px;
            color: #ccc;
        }

        .serving-info {
            font-size: 14px;
            color: #4CAF50;
            margin-top: 5px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .nutrition-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nutrition-value {
            font-size: 20px;
            font-weight: 600;
            color: #4CAF50;
        }

        .nutrition-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 2px;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .export-section {
            margin-top: 20px;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status-message.error {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2f4f49;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .product-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 0 auto 20px;
            display: block;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <header>
        <img src="https://img1.wsimg.com/isteam/ip/17da66aa-05e0-4e17-aec0-570151a3c322/blob-f3b648f.png/:/rs=w:198,h:112,cg:true,m/cr=w:198,h:112/qt=q:95" alt="Calculated Decisions Logo" class="company-logo">
        <br>
        <a href="https://calculated-decisions.com/" class="company-name" target="_blank">Calculated Decisions</a>
        <h1>🍎 Food Scanner & Nutrition Tracker</h1>
        <p class="subtitle">Scan barcodes to track nutrition info</p>
    </header>

    <main>
        <div id="scanner-container">
            <div id="scanner"></div>
            <div class="scanner-overlay"></div>
        </div>

        <div class="controls">
            <button id="startBtn" class="primary-btn">Start Scanner</button>
            <button id="stopBtn" class="secondary-btn" style="display: none;">Stop Scanner</button>
        </div>

        <div class="manual-entry">
            <h3 style="margin-bottom: 15px;">Manual Entry</h3>
            <div class="form-group">
                <label for="foodName">Food Name</label>
                <input type="text" id="foodName" placeholder="e.g., Organic Pasta">
            </div>
            <div class="form-group">
                <label for="barcode">Barcode (optional)</label>
                <div class="barcode-input-group">
                    <input type="text" id="barcode" placeholder="e.g., 123456789">
                    <button type="button" id="fetchBtn" class="fetch-button" onclick="fetchByBarcode()">Fetch Info</button>
                </div>
            </div>
            <div class="form-group">
                <label for="brand">Brand (optional)</label>
                <input type="text" id="brand" placeholder="e.g., Nature's Best">
            </div>
            <div class="form-group">
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label>Nutrition per serving (optional)</label>
                <div class="serving-size-group">
                    <input type="text" id="servingSize" placeholder="Serving size (e.g., 1 cup, 100g)">
                    <input type="number" id="servingsPerContainer" placeholder="Servings per container" step="0.1">
                </div>
                <div class="nutrition-inputs">
                    <input type="number" id="calories" placeholder="Calories" step="0.1">
                    <input type="number" id="protein" placeholder="Protein (g)" step="0.1">
                    <input type="number" id="carbs" placeholder="Carbs (g)" step="0.1">
                    <input type="number" id="fat" placeholder="Fat (g)" step="0.1">
                    <input type="number" id="fiber" placeholder="Fiber (g)" step="0.1">
                    <input type="number" id="sugar" placeholder="Sugar (g)" step="0.1">
                    <input type="number" id="sodium" placeholder="Sodium (mg)" step="0.1">
                    <input type="number" id="saturatedFat" placeholder="Saturated Fat (g)" step="0.1">
                </div>
            </div>
            <button onclick="addManualItem()" class="primary-btn">Add Item</button>
        </div>

        <div class="food-list">
            <h3 style="margin-bottom: 15px;">Your Food Inventory</h3>
            <div id="foodItems"></div>
        </div>

        <div class="export-section">
            <button onclick="exportToCSV()" class="export-btn">📥 Export to CSV</button>
        </div>
    </main>

    <div id="statusMessage" class="status-message"></div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Product Found!</div>
            <img id="productImage" class="product-image" src="" alt="">
            <div id="productInfo"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="confirmProduct()" class="primary-btn">Add to Inventory</button>
                <button onclick="closeModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let foodInventory = [];
        let scanning = false;
        let pendingProduct = null;

        // Load saved inventory
        function loadInventory() {
            const saved = localStorage.getItem('foodInventory');
            if (saved) {
                foodInventory = JSON.parse(saved);
                updateDisplay();
            }
        }

        // Save inventory
        function saveInventory() {
            localStorage.setItem('foodInventory', JSON.stringify(foodInventory));
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Fetch product info from Open Food Facts API
        async function fetchProductInfo(barcode, useServingSize = true) {
            try {
                showStatus('Fetching product information...', 'success');
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const product = data.product;
                    const nutrition = product.nutriments || {};
                    
                    // Try to get serving size nutrition first
                    let nutritionData = {
                        calories: 0,
                        protein: 0,
                        carbs: 0,
                        fat: 0,
                        fiber: 0,
                        sugar: 0,
                        sodium: 0
                    };
                    
                    let servingSize = product.serving_size || '';
                    let nutritionPer = 'per serving';
                    
                    if (useServingSize && nutrition['energy-kcal_serving']) {
                        // Use serving size data
                        nutritionData = {
                            calories: Math.round(nutrition['energy-kcal_serving'] || 0),
                            protein: Math.round((nutrition.proteins_serving || 0) * 10) / 10,
                            carbs: Math.round((nutrition.carbohydrates_serving || 0) * 10) / 10,
                            fat: Math.round((nutrition.fat_serving || 0) * 10) / 10,
                            fiber: Math.round((nutrition.fiber_serving || 0) * 10) / 10,
                            sugar: Math.round((nutrition.sugars_serving || 0) * 10) / 10,
                            sodium: Math.round((nutrition.salt_serving || 0) * 1000) || 0 // Salt is actually sodium in mg
                        };
                    } else if (nutrition['energy-kcal_100g']) {
                        // Fall back to 100g data
                        nutritionData = {
                            calories: Math.round(nutrition['energy-kcal_100g'] || 0),
                            protein: Math.round((nutrition.proteins_100g || 0) * 10) / 10,
                            carbs: Math.round((nutrition.carbohydrates_100g || 0) * 10) / 10,
                            fat: Math.round((nutrition.fat_100g || 0) * 10) / 10,
                            fiber: Math.round((nutrition.fiber_100g || 0) * 10) / 10,
                            sugar: Math.round((nutrition.sugars_100g || 0) * 10) / 10,
                            sodium: Math.round((nutrition.salt_100g || 0) * 1000) || 0 // Salt is actually sodium in mg
                        };
                        nutritionPer = 'per 100g';
                        if (!servingSize) servingSize = '100g';
                    }
                    
                    return {
                        name: product.product_name || `Product ${barcode}`,
                        brand: product.brands || 'Unknown Brand',
                        barcode: barcode,
                        image: product.image_url || '',
                        nutrition: nutritionData,
                        servingSize: servingSize,
                        nutritionPer: nutritionPer,
                        servingsPerContainer: product.servings_per_container || ''
                    };
                } else {
                    return {
                        name: `Product ${barcode}`,
                        brand: 'Unknown',
                        barcode: barcode,
                        nutrition: null
                    };
                }
            } catch (error) {
                console.error('Error fetching product:', error);
                showStatus('Could not fetch product info', 'error');
                return {
                    name: `Product ${barcode}`,
                    brand: 'Unknown',
                    barcode: barcode,
                    nutrition: null
                };
            }
        }

        // Fetch by barcode button
        async function fetchByBarcode() {
            const barcode = document.getElementById('barcode').value.trim();
            if (!barcode) {
                showStatus('Please enter a barcode', 'error');
                return;
            }
            
            const productInfo = await fetchProductInfo(barcode);
            
            if (productInfo.name !== `Product ${barcode}`) {
                // Populate form fields
                document.getElementById('foodName').value = productInfo.name;
                document.getElementById('brand').value = productInfo.brand;
                
                if (productInfo.nutrition) {
                    document.getElementById('servingSize').value = productInfo.servingSize || '';
                    document.getElementById('servingsPerContainer').value = productInfo.servingsPerContainer || '';
                    document.getElementById('calories').value = productInfo.nutrition.calories || '';
                    document.getElementById('protein').value = productInfo.nutrition.protein || '';
                    document.getElementById('carbs').value = productInfo.nutrition.carbs || '';
                    document.getElementById('fat').value = productInfo.nutrition.fat || '';
                    document.getElementById('fiber').value = productInfo.nutrition.fiber || '';
                    document.getElementById('sugar').value = productInfo.nutrition.sugar || '';
                    document.getElementById('sodium').value = productInfo.nutrition.sodium || '';
                }
                
                showStatus(`Product found: ${productInfo.name}`, 'success');
            } else {
                showStatus('Product not found in database', 'error');
            }
        }

        // Show product modal
        function showProductModal(product) {
            pendingProduct = product;
            const modal = document.getElementById('productModal');
            const image = document.getElementById('productImage');
            const info = document.getElementById('productInfo');
            
            if (product.image) {
                image.src = product.image;
                image.style.display = 'block';
            } else {
                image.style.display = 'none';
            }
            
            let nutritionHtml = '';
            if (product.nutrition && product.nutrition.calories !== undefined) {
                nutritionHtml = `
                    <p style="text-align: center; color: #4CAF50; margin-bottom: 10px;">
                        ${product.nutritionPer || 'per serving'} ${product.servingSize ? `(${product.servingSize})` : ''}
                    </p>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.calories}</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.protein}g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.carbs}g</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.fat}g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                        ${product.nutrition.sodium ? `
                        <div class="nutrition-item">
                            <div class="nutrition-value">${product.nutrition.sodium}</div>
                            <div class="nutrition-label">Sodium (mg)</div>
                        </div>` : ''}
                    </div>
                `;
            } else {
                nutritionHtml = '<p style="color: #ccc; text-align: center; margin-top: 10px;">No nutrition information available</p>';
            }
            
            info.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 5px;">${product.name}</h3>
                <p style="text-align: center; color: #ccc; margin-bottom: 15px;">${product.brand}</p>
                ${nutritionHtml}
            `;
            
            modal.style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            pendingProduct = null;
        }

        // Confirm product
        function confirmProduct() {
            if (pendingProduct) {
                const foodItem = {
                    id: Date.now(),
                    ...pendingProduct,
                    quantity: 1,
                    dateAdded: new Date().toISOString()
                };
                
                foodInventory.push(foodItem);
                saveInventory();
                updateDisplay();
                showStatus(`Added: ${pendingProduct.name}`);
                closeModal();
            }
        }

        // Initialize Quagga2 scanner
        function initializeScanner() {
            if (scanning) return;
            
            scanning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            
            // Check if mobile or desktop
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            const config = {
                inputStream: {
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 },
                        facingMode: isMobile ? "environment" : "user" // Use front camera for webcams
                    }
                },
                locator: {
                    patchSize: "large", // Larger patch for webcams
                    halfSample: false   // Don't downsample for better accuracy
                },
                numOfWorkers: 4,
                frequency: 5,  // Slower frequency for better accuracy
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader", 
                        "upc_reader",
                        "upc_e_reader",
                        "code_128_reader" // Added for more barcode types
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: false,
                        drawScanline: true,
                        showPattern: false
                    }
                },
                locate: true
            };
            
            Quagga.init(config, function(err) {
                if (err) {
                    console.error('Quagga init error:', err);
                    showStatus('Camera access denied or not available', 'error');
                    scanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    return;
                }
                console.log("Scanner initialized");
                Quagga.start();
                
                // Add visual feedback
                showStatus('Scanner ready - hold barcode steady', 'success');
            });

            // Process results with visual feedback
            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                    }
                }
            });

            // Detection handling with lower threshold for webcams
            let detectionBuffer = [];
            
            Quagga.onDetected(async function(result) {
                const code = result.codeResult.code;
                const format = result.codeResult.format;
                console.log('Detection:', format, code);
                
                // Add to buffer
                detectionBuffer.push(code);
                
                // Keep only last 5 detections for webcams (faster confirmation)
                if (detectionBuffer.length > 5) {
                    detectionBuffer.shift();
                }
                
                // Count occurrences
                const counts = {};
                detectionBuffer.forEach(c => {
                    counts[c] = (counts[c] || 0) + 1;
                });
                
                // Find most common code
                let mostCommon = null;
                let maxCount = 0;
                for (const [barcode, count] of Object.entries(counts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mostCommon = barcode;
                    }
                }
                
                // Need at least 3 consistent reads for webcams (lower threshold)
                if (maxCount >= 3) {
                    console.log('Confirmed barcode:', mostCommon);
                    
                    // Stop scanning
                    Quagga.stop();
                    scanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    
                    // Reset buffer
                    detectionBuffer = [];
                    
                    // Fetch product info
                    const productInfo = await fetchProductInfo(mostCommon);
                    showProductModal(productInfo);
                }
            });
        }

        // Start scanner
        document.getElementById('startBtn').addEventListener('click', initializeScanner);

        // Stop scanner
        document.getElementById('stopBtn').addEventListener('click', function() {
            if (scanning) {
                Quagga.stop();
                scanning = false;
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
            }
        });

        // Add manual item
        function addManualItem() {
            const name = document.getElementById('foodName').value.trim();
            const barcode = document.getElementById('barcode').value.trim();
            const brand = document.getElementById('brand').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const servingSize = document.getElementById('servingSize').value.trim();
            const servingsPerContainer = document.getElementById('servingsPerContainer').value.trim();

            if (!name) {
                showStatus('Please enter a food name', 'error');
                return;
            }

            const foodItem = {
                id: Date.now(),
                barcode: barcode || 'N/A',
                name: name,
                brand: brand || 'Generic',
                quantity: quantity,
                servingSize: servingSize || '1 serving',
                servingsPerContainer: servingsPerContainer || '',
                nutrition: {
                    calories: parseFloat(document.getElementById('calories').value) || 0,
                    protein: parseFloat(document.getElementById('protein').value) || 0,
                    carbs: parseFloat(document.getElementById('carbs').value) || 0,
                    fat: parseFloat(document.getElementById('fat').value) || 0,
                    fiber: parseFloat(document.getElementById('fiber').value) || 0,
                    sugar: parseFloat(document.getElementById('sugar').value) || 0,
                    sodium: parseFloat(document.getElementById('sodium').value) || 0,
                    saturatedFat: parseFloat(document.getElementById('saturatedFat').value) || 0
                },
                dateAdded: new Date().toISOString()
            };

            foodInventory.push(foodItem);
            saveInventory();
            updateDisplay();
            
            // Clear form
            document.getElementById('foodName').value = '';
            document.getElementById('barcode').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('servingSize').value = '';
            document.getElementById('servingsPerContainer').value = '';
            document.getElementById('calories').value = '';
            document.getElementById('protein').value = '';
            document.getElementById('carbs').value = '';
            document.getElementById('fat').value = '';
            document.getElementById('fiber').value = '';
            document.getElementById('sugar').value = '';
            document.getElementById('sodium').value = '';
            document.getElementById('saturatedFat').value = '';
            
            showStatus('Item added successfully');
        }

        // Delete item
        function deleteItem(id) {
            foodInventory = foodInventory.filter(item => item.id !== id);
            saveInventory();
            updateDisplay();
            showStatus('Item removed');
        }

        // Update display
        function updateDisplay() {
            const container = document.getElementById('foodItems');
            
            if (foodInventory.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in inventory. Start scanning or add items manually!</div>';
                return;
            }

            container.innerHTML = foodInventory.map(item => {
                let nutritionHtml = '';
                if (item.nutrition && item.nutrition.calories !== undefined) {
                    nutritionHtml = `
                        <div class="nutrition-grid">
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.calories}</div>
                                <div class="nutrition-label">Calories</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.protein}g</div>
                                <div class="nutrition-label">Protein</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.carbs}g</div>
                                <div class="nutrition-label">Carbs</div>
                            </div>
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.fat}g</div>
                                <div class="nutrition-label">Fat</div>
                            </div>
                            ${item.nutrition.sodium ? `
                            <div class="nutrition-item">
                                <div class="nutrition-value">${item.nutrition.sodium}</div>
                                <div class="nutrition-label">Sodium (mg)</div>
                            </div>` : ''}
                        </div>
                    `;
                }
                
                const servingInfo = item.servingSize ? `<div class="serving-info">Serving: ${item.servingSize}</div>` : '';
                
                return `
                    <div class="food-item">
                        <div class="food-header">
                            <div class="food-info">
                                <div class="food-name">${item.name}</div>
                                <div class="food-details">
                                    ${item.brand} • Qty: ${item.quantity} • Barcode: ${item.barcode}
                                </div>
                                ${servingInfo}
                            </div>
                            <button class="delete-btn" onclick="deleteItem(${item.id})">Delete</button>
                        </div>
                        ${nutritionHtml}
                    </div>
                `;
            }).join('');
        }

        // Export to CSV
        function exportToCSV() {
            if (foodInventory.length === 0) {
                showStatus('No items to export', 'error');
                return;
            }

            const headers = ['Name', 'Brand', 'Barcode', 'Quantity', 'Serving Size', 'Servings Per Container', 'Calories', 'Protein (g)', 'Carbs (g)', 'Fat (g)', 'Fiber (g)', 'Sugar (g)', 'Sodium (mg)', 'Date Added'];
            const rows = foodInventory.map(item => [
                item.name,
                item.brand || '',
                item.barcode,
                item.quantity,
                item.servingSize || '',
                item.servingsPerContainer || '',
                item.nutrition?.calories || '',
                item.nutrition?.protein || '',
                item.nutrition?.carbs || '',
                item.nutrition?.fat || '',
                item.nutrition?.fiber || '',
                item.nutrition?.sugar || '',
                item.nutrition?.sodium || '',
                new Date(item.dateAdded).toLocaleDateString()
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food_inventory_nutrition_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showStatus('Inventory exported successfully');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadInventory();
        });

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
